<section class="m-4 seccion container m-auto">

    @if (cargado) {
    @if (viaje !== null) {

    <div class="sello-finalizado" [ngClass]="{ 'activo': esFinalizado }">
        <span class="texto-sello">¡Este viaje ha llegado a su fin!</span>
        <p class="mensaje-sello">Pero no te preocupes, ¡tenemos muchos más por descubrir! Explora nuevas aventuras y
            únete a nuestro próximo destino.</p>
        <a class="btn btn-warning" routerLink="/viajes">Ver más viajes</a>
    </div>

    <div class="container d-flex justify-content-center align-items-center mt-5 mb-5">
        <div class="card shadow-lg border-0 rounded-4" [ngClass]="{ 'finalizado': esFinalizado }"
            style="max-width: 800px; width: 100%;">


            <img [src]="viaje.imagen || 'https://fundacionglobalnature.org/wp-content/plugins/elementor/assets/images/placeholder.png'"
                class="card-img-top rounded-top-4" alt="Imagen del viaje" style="height: 350px; object-fit: cover;" />

            <div class="card-body p-4">
                <h2 class="card-title fw-bold text-primary mb-3">{{ viaje.nombre_viaje }}</h2>

                @if (anfitrion !== null) {
                <div class="d-flex align-items-center gap-3 mb-3" style="cursor: pointer;"
                    [routerLink]="['/perfil-usuario', anfitrion.id]">
                    <img [src]="anfitrion.imagen || 'https://st3.depositphotos.com/6672868/13701/v/450/depositphotos_137014128-stock-illustration-user-profile-icon.jpg'"
                        alt="Foto del anfitrión" class="rounded-circle" width="50" height="50">
                    <div>
                        <small class="text-muted">Anfitrión</small><br />
                        <strong>{{ anfitrion.nombre }}</strong>
                    </div>
                </div>
                }

                <ul class="list-group list-group-flush mb-3 rounded-4">
                    <li class="list-group-item"><strong>📍 Localización:</strong> {{ viaje.localizacion }}</li>
                    <li class="list-group-item"><strong>📅 Fecha de inicio:</strong> {{ viaje.fecha_inicio | date:
                        'dd-MM-YYYY' }}</li>
                    <li class="list-group-item"><strong>📅 Fecha de fin:</strong> {{ viaje.fecha_fin | date:
                        'dd-MM-YYYY' }}</li>
                    <li class="list-group-item"><strong>💸 Coste por persona:</strong> {{ viaje.coste_por_persona }} €
                    </li>
                    <li class="list-group-item"><strong>👥 Personas mínimas:</strong> {{ viaje.personas_minimas }}</li>
                    <li class="list-group-item"><strong>🧭 Itinerario:</strong> {{ viaje.itinerario }}</li>
                </ul>

                <!-- Estado del cupo -->
                <div class="mt-4">
                    <h5 class="fw-bold">📊 Estado del cupo</h5>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar" role="progressbar"
                            [ngClass]="{'bg-danger': progresoCupo < 50,'bg-warning': progresoCupo >= 50 && progresoCupo < 100, 'bg-success': progresoCupo >= 100}"
                            [style.width.%]="progresoCupo">
                            {{ progresoCupo }}%
                        </div>
                    </div>

                    @if (progresoCupo >= 100) {
                    <div class="alert alert-success mt-2">
                        ¡Cupo mínimo alcanzado! 🎉
                    </div>
                    } @else if (progresoCupo >= 75 && progresoCupo < 100) { <div class="alert alert-warning mt-2">
                        ¡Ya casi lo logramos! ¡Faltan pocas personas para alcanzar el mínimo! 💪
                </div>
                } @else {
                <div class="alert alert-info mt-2">
                    ¡Invitá a tus amigos a sumarse y hagamos que este viaje suceda! 🚀
                </div>
                }
            </div>


            <div class="text-center mt-4 d-flex justify-content-center gap-2 flex-wrap">
                @if (!esFinalizado) {
                @if (esAnfitrion) {
                <button class="btn btn-warning" [routerLink]="['/viajes', viaje.id_viaje, 'editar']">✏️ Editar
                    viaje</button>
                <button class="btn btn-danger" (click)="eliminarViaje()">🗑️ Eliminar viaje</button>
                <button class="btn btn-secondary" (click)="finalizarViaje()">✅ Finalizar viaje</button>
                } @else if (esParticipante) {
                <button class="btn btn-danger" (click)="abandonar()">🚪 Abandonar viaje</button>
                } @else {
                <button class="btn btn-success" (click)="unirse()">➕ Unirse al viaje</button>
                }
                }
            </div>
        </div>
    </div>
    </div>

    <h3 class="text-center fw-bold text-primary">Participantes</h3>

    <app-participantes [participantes]="participantes" [esAnfitrion]="esAnfitrion"
        [viajeId]="viaje.id_viaje"></app-participantes>

    @if (!esFinalizado && puedeComentar) {
    <app-comentarios [viajeId]="viaje.id_viaje"></app-comentarios>
    } @else if (!esFinalizado) {
    <h5 class="text-center mt-5 text-muted p-5">Tienes que ser aceptado en el viaje para comentar.</h5>
    }

    @if (esFinalizado) {
    <app-review [viajeId]="viaje.id_viaje"></app-review>
    }

    <!-- Sticky button -->
    <button class="btn btn-primary btn-sticky" (click)="redirectToViajes()">← Volver a viajes</button>

    } @else {
    <p class="text-center mt-5 text-muted">No se encontró el viaje.</p>
    }
    } @else {
    <p class="text-center mt-5 text-muted">Cargando datos del viaje...</p>
    }

</section>